#!/bin/bash

echo 'umc installation script started.'

export umc_src="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && cd .. && pwd )"

function doasroot {
    #binaries, libraries, probes | keep it protected!
    mkdir -p /opt/umc

    cp -r $umc_src /opt/umc

    chmod -R 444 /opt/umc

    cd /opt/umc/bin
    for file in *.sh *.pl *.py csv2obd dvdt flag foreach get when run start-* stop-* umcpushd umcrunner umcrunnerd; do 
    chmod 555 $file
    done
    cd - > /dev/null

    #configuration | keep it protected!
    mkdir -p /etc/umc
    cp -r $umc_src/etc/* /etc/umc
    chmod -R 444 /etc/umc

    #runtime
    mkdir -p /run/umc/obd; chmod 666 /run/umc/obd
    mkdir -p /var/log/umc; chmod 666 /var/log/umc

    #make all direc accessible for all
    find /etc/umc -type d -exec chmod 755 {} +
    find /opt/umc -type d -exec chmod 755 {} +
    find /run/umc -type d -exec chmod 755 {} +
    find /var/log -type d -exec chmod 755 {} +
}

FUNC=$(declare -f doasroot)
sudo bash -c "umc_src=$umc_src; $FUNC; doasroot"

grep '# umc init' ~/.bash_profile
if [ $? -ne 0 ]; then
    echo '# umc init' >>~/.bash_profile
    echo '. /opt/umc/bin/umc.h' >>~/.bash_profile
fi

echo 'Done.'