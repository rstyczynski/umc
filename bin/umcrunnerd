#!/bin/bash
# umcrunner daemon script running umcrunner --runall 

# the script directory
scriptDir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

if [ "$UMCRUNNER_CONF" = "" ]; then
  echo >&2 "umcrunner configuration in \$UMCRUNNER_CONF variable has not been set!"
  exit 1  
fi 

# lockfile
lockfile=$scriptDir/.umcrunnerd-$HOSTNAME.lck

# on this machine run only once at a time
if [ -e $lockfile ]; then
   echo >&2 "Already running!"
   exit 1
fi

trap "rm -f $lockfile; exit" SIGINT SIGTERM EXIT
touch $lockfile

while true; do
  $scriptDir/umcrunner --runall $UMCRUNNER_CONF
  sleep 15
done

rm $lockfile
trap - SIGINT SIGTERM EXIT
