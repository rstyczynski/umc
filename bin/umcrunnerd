#!/bin/bash
# umcrunner daemon script running umcrunner --runall 

# the script directory
scriptDir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

source $scriptDir/umc.h &>/dev/null

if [ "$UMCRUNNER_CONF" = "" ]; then
  echo >&2 "umcrunner configuration in \$UMCRUNNER_CONF variable has not been set!"
  exit 1  
fi 

if [ "$UMC_LOG_DIR" = "" ]; then
  echo >&2 "umc log directory in \$UMC_LOG_DIR variable has not been set!"
  exit 1
fi

if [ ! -d $UMC_LOG_DIR/umcrunner ]; then
  mkdir -p $UMC_LOG_DIR/umcrunner/
fi

# lockfile
lockfile=$scriptDir/.umcrunnerd-$HOSTNAME.lck

# on this machine run only once at a time
if [ -e $lockfile ]; then
   echo >&2 "Already running!"
   exit 1
fi

trap "$scriptDir/umcrunner --stopall >>$UMC_LOG_DIR/umcrunner/umcrunner-$HOSTNAME.log 2>&1; rm -f $lockfile; exit 0" SIGINT SIGTERM EXIT

touch $lockfile

while true; do
  $scriptDir/umcrunner --runall $UMCRUNNER_CONF >>$UMC_LOG_DIR/umcrunner/umcrunner-$HOSTNAME.log 2>&1
  sleep 15
done

rm $lockfile

trap - SIGINT SIGTERM EXIT
