# -*- mode: ruby -*-
# vi: set ft=ruby :

# This is the vagrant file for umc test machine based on Oracle Enterprise Linux 5.11
# in order to use this, you need to import the box as follows:
#
# 	vagrant box add --name oel511 http://cloud.terry.im/vagrant/oraclelinux-5-x86_64.box
#

servers=[
  {
    :hostname => "ukbn01hr",
    :ip => "192.168.10.101",
    :box => "oel511",
    :ram => 512,
    :cpu => 2
  },
  {
    :hostname => "ukbn02hr",
    :ip => "192.168.10.102",
    :box => "oel511",
    :ram => 512,
    :cpu => 2
  },
  {
    :hostname => "ukbn03hr",
    :ip => "192.168.10.103",
    :box => "oel511",
    :ram => 512,
    :cpu => 2
  }
]


Vagrant.configure("2") do |config|
    
    # disable guest additions upgrade 
    config.vbguest.auto_update = false
    
    # configure and provision servers
    servers.each do |machine|
        
        # define the machines
        config.vm.define machine[:hostname] do |node|
            node.vm.box = machine[:box]
            node.vm.hostname = machine[:hostname]
            node.vm.network "private_network", ip: machine[:ip]
            node.vm.provider "virtualbox" do |vb|
                vb.customize ["modifyvm", :id, "--memory", machine[:ram]]
            end
            
          # this will map the umc root to the vagrant's home umc directory
          node.vm.synced_folder "../../", "/home/vagrant/umc"
           
   	      node.vm.provision "shell", privileged: false, inline: <<-SHELL
      		  # set Europe/Prague timezone 
      		  sudo rm /etc/localtime && sudo ln -s /usr/share/zoneinfo/Europe/Prague /etc/localtime

        		# writes a line to bash_profile
        		w2p () {
            		echo $1 >>~/.bash_profile
       	 	  }

        		# remove old logs directory 
            rm -fr ~/umc/test/oel-511/logs

            ~/umc/varia/bin/install-libs.sh --yes --no-python-zlib

            # link dms and sql collectors to their original location
            # this is for better debug/dev purposes
            cd ~/libs
            rm -fr dms-collector
            ln -s ~/umc/varia/dms-collector dms-collector
            rm -fr sql-collector
            ln -s ~/umc/varia/sql-collector sql-collector

            # other settings on user login
            echo "Writing misc settings to bash_profile"
            w2p ""
            w2p "# various settings"
            w2p "export LS_COLORS=''"
            w2p "alias ll='ls -all --color=always'"

            # initialize umc on user login
            echo "Writing umc settings to bash_profile"
            w2p ""
            w2p "# umc startup"
            w2p "source ~/libs/umc-libs-env.sh"
            w2p "source ~/umc/test/oel-511/umc-startup.sh"
          SHELL
        end
    end
end


# Vagrant.configure("2") do |config|
#   config.vm.box = "oel511"
# 
#   # this will map the umc root to the vagrant's home umc directory
#   config.vm.synced_folder "../../", "/home/vagrant/umc"
# 
#   # disable guest additions upgrade 
#   config.vbguest.auto_update = false
# 
#   # network
#   config.vm.network :private_network, ip: "192.168.10.101"
# 
#   config.vm.provider "virtualbox" do |box1|
#       box1.name = "umc_oel511_vm"
#       box1.memory = "512"
# 
#   end
# 
#   config.vm.provision "shell", privileged: false, inline: <<-SHELL
#     # set Europe/Prague timezone 
#     sudo rm /etc/localtime && sudo ln -s /usr/share/zoneinfo/Europe/Prague /etc/localtime
# 
#     # writes a line to bash_profile
#     w2p () {
# 	echo $1 >>~/.bash_profile
#     }
# 
#     # remove old logs directory 
#     rm -fr ~/umc/test/oel-511/logs
# 
#     ~/umc/varia/bin/install-libs.sh --yes --no-python-zlib
# 
#     # link dms and sql collectors to their original location
#     # this is for better debug/dev purposes
#     cd ~/libs
#     rm -fr dms-collector
#     ln -s ~/umc/varia/dms-collector dms-collector
#     rm -fr sql-collector
#     ln -s ~/umc/varia/sql-collector sql-collector
# 
#     # other settings on user login
#     echo "Writing misc settings to bash_profile" 
#     w2p ""
#     w2p "# various settings" 
#     w2p "export LS_COLORS=''"
#     w2p "alias ll='ls -all --color=always'"
# 
#     # initialize umc on user login
#     echo "Writing umc settings to bash_profile"
#     w2p ""
#     w2p "# umc startup"
#     w2p "source ~/libs/umc-libs-env.sh"
#     w2p "source ~/umc/test/oel-511/umc-startup.sh"
# 
#   SHELL
# 
# 
# end
